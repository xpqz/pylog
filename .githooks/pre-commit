#!/usr/bin/env bash
set -euo pipefail

# Pre-commit hook to block conditional or late imports in Python files.
# Enforces project policy: no conditional imports; all imports at file top only.

# Collect staged Python files (added/copied/modified/renamed)
py_files=()
while IFS= read -r -d '' f; do
  if [[ "$f" == *.py ]]; then
    py_files+=("$f")
  fi
done < <(git diff --cached --name-only --diff-filter=ACMR -z)

if [[ ${#py_files[@]} -eq 0 ]]; then
  exit 0
fi

# 1) Auto-format with black and re-stage
if command -v uv >/dev/null 2>&1; then
  uv run black "${py_files[@]}"
else
  black "${py_files[@]}"
fi
git add -- "${py_files[@]}"

# 2) Ruff lint: auto-fix then enforce clean
if command -v uv >/dev/null 2>&1; then
  uv run ruff check --fix "${py_files[@]}"
  git add -- "${py_files[@]}"
  uv run ruff check "${py_files[@]}"
else
  ruff check --fix "${py_files[@]}"
  git add -- "${py_files[@]}"
  ruff check "${py_files[@]}"
fi

# Run checker on staged files
python3 scripts/check_no_conditional_imports.py "${py_files[@]}" || {
  echo
  echo "Commit aborted: conditional or late imports detected."
  echo "Fix the issues above and re-stage your changes."
  exit 1
}

exit 0
